package require tcltest
namespace import ::tcltest::test

set root [file normalize [file join [file dirname [info script]] ".."]]
source [file join $root "lib" "qemu_utils.tcl"]

set manifestValid {
    {
        "constraints": {
            "maxMemory": 8192,
            "maxCPUs": 4,
            "maxDisks": 3
        }
    }
}

test manifest_validates_expected_values {constraints match expected numbers} -body {
    set expected [dict create maxMemory 8192 maxCPUs 4 maxDisks 3]
    set result [::qemu::manifest::validate $manifestValid $expected]
    list [dict get $result ok] [dict get $result errors]
} -result {1 {}}

test manifest_detects_wrong_value {mismatched constraint reports error} -body {
    set expected [dict create maxMemory 8192 maxCPUs 6 maxDisks 3]
    set result [::qemu::manifest::validate $manifestValid $expected]
    expr {[dict get $result ok] == 0 && [llength [dict get $result errors]] == 1}
} -result 1

test manifest_invalid_json_reports_failure {bad JSON is flagged even without json package} -body {
    set badManifest {constraints: {maxMemory: 1}}
    set expected [dict create maxMemory 1]
    set result [::qemu::manifest::validate $badManifest $expected]
    list [dict get $result ok] [llength [dict get $result errors]]
} -result {0 1}
